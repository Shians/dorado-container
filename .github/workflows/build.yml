name: Build Dorado Images

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_docker:
    name: Build and push Docker image to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Read Dorado version
        id: version
        run: echo "DORADO_VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ steps.version.outputs.DORADO_VERSION }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            DORADO_VER=${{ steps.version.outputs.DORADO_VERSION }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build_singularity:
    name: Build and push Singularity image to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Read Dorado version
        id: version
        run: echo "DORADO_VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Build Singularity image
        run: |
          echo "Building Dorado version: ${{ steps.version.outputs.DORADO_VERSION }}"
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/work \
            -w /work \
            quay.io/singularity/singularity:v3.10.4 \
            build dorado.sif dorado.def

      - name: Login and push to GHCR (OCI format)
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get repository name in lowercase
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          # Get version
          DORADO_VER="${{ steps.version.outputs.DORADO_VERSION }}"

          # Create directory for Singularity config
          mkdir -p ${{ github.workspace }}/.singularity

          # Login using Singularity via Docker
          echo "$GHCR_TOKEN" | docker run --rm -i --privileged \
            -v ${{ github.workspace }}:/work \
            -v ${{ github.workspace }}/.singularity:/root/.singularity \
            -w /work \
            quay.io/singularity/singularity:v3.10.4 \
            remote login -u ${{ github.actor }} --password-stdin oras://ghcr.io

          # Push with version tag
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/work \
            -v ${{ github.workspace }}/.singularity:/root/.singularity \
            -w /work \
            quay.io/singularity/singularity:v3.10.4 \
            push dorado.sif oras://ghcr.io/${REPO_LOWER}:${DORADO_VER}-singularity

          # Push latest tag if on main branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            docker run --rm --privileged \
              -v ${{ github.workspace }}:/work \
              -v ${{ github.workspace }}/.singularity:/root/.singularity \
              -w /work \
              quay.io/singularity/singularity:v3.10.4 \
              push dorado.sif oras://ghcr.io/${REPO_LOWER}:latest-singularity
          fi

      - name: Upload Singularity image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dorado-singularity
          path: dorado.sif
          retention-days: 30
