Bootstrap: docker
From: nvidia/cuda:12.8.1-runtime-rockylinux8

%files
    VERSION /VERSION
    CHECKSUM /CHECKSUM

%post
    # Install dependencies
    yum -y install curl tar ca-certificates procps-ng && \
    yum clean all && rm -rf /var/cache/yum

    # Read version and checksum from files
    DORADO_VER=$(cat /VERSION | tr -d '[:space:]')
    DORADO_SHA256=$(cat /CHECKSUM | tr -d '[:space:]')

    echo "Building Dorado version: ${DORADO_VER}"
    echo "Expected SHA256: ${DORADO_SHA256}"

    # Set download URL
    DORADO_URL=https://cdn.oxfordnanoportal.com/software/analysis/dorado-${DORADO_VER}-linux-x64.tar.gz

    # Download and install dorado
    set -euxo pipefail
    mkdir -p /opt/dorado
    curl -L "${DORADO_URL}" -o /tmp/dorado.tar.gz
    echo "${DORADO_SHA256}  /tmp/dorado.tar.gz" | sha256sum -c -
    tar -xzf /tmp/dorado.tar.gz -C /opt/dorado --strip-components=1
    rm -f /tmp/dorado.tar.gz

    # Sanity check
    /opt/dorado/bin/dorado --version || (echo "dorado not found" && exit 1)

    # Create dynamic labels JSON
    cat > /.singularity.d/labels.json <<EOF
{
    "Author": "dorado-container",
    "Version": "${DORADO_VER}",
    "Dorado_Version": "${DORADO_VER}",
    "org.label-schema.schema-version": "1.0",
    "org.label-schema.build-date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
}
EOF

%environment
    export PATH="/opt/dorado/bin:${PATH}"

%runscript
    exec dorado "$@"

%help
    This container provides the Dorado basecaller for Oxford Nanopore sequencing data.
    It includes CUDA 12.8.1 runtime support for GPU acceleration.

    Usage:
        singularity exec dorado.sif dorado <command>
        singularity run dorado.sif <command>

    Example:
        singularity exec dorado.sif dorado basecaller --help
